graph TB
    %% Users and External Access
    Users[End Users]
    Developers[Developers]
    
    %% DNS Layer
    subgraph "DNS Management"
        Cloudflare[Cloudflare DNS]
        
        subgraph "Domain Strategy"
            ProdDomain[sgcarstrends.com]
            StagingDomain[staging.sgcarstrends.com]
            DevDomain[dev.sgcarstrends.com]
            APIDomain[api.sgcarstrends.com]
            APIStagingDomain[api.staging.sgcarstrends.com]
            APIDevDomain[api.dev.sgcarstrends.com]
        end
    end
    
    %% AWS Infrastructure - Singapore Region
    subgraph "AWS ap-southeast-1 (Singapore)"
        %% CDN Layer
        subgraph "Content Delivery"
            CloudFront[CloudFront Distribution]
            Router[SST Router - SGCarsTrends]
        end
        
        %% API Infrastructure  
        subgraph "API Service Infrastructure"
            APIGateway[API Gateway]
            APILambda[API Lambda Function]
            
            subgraph "API Function Config"
                APIRuntime[Node.js 22.x - arm64]
                APITimeout[120 second timeout]
                HonoApp[Hono Framework App]
            end
        end
        
        %% Web Infrastructure
        subgraph "Web Application Infrastructure"
            NextjsSSR[Next.js SSR Functions]
            StaticAssets[Static Assets]
            
            subgraph "Web Function Config"
                WebRuntime[Node.js 22.x - arm64]
                WebWarm[1 Warm Instance]
                NextjsFramework[Next.js 15 Framework]
            end
        end
        
        %% Lambda Functions Detail
        subgraph "Lambda Function Details"
            subgraph "API Lambda Environment"
                CoreEnv[Core: STAGE, DATABASE_URL, API_TOKEN]
                AIEnv[AI: GEMINI_API_KEY] 
                QStashEnv[QStash: QSTASH_TOKEN, SIGNING_KEYS]
                RedisEnv[Redis: UPSTASH_REDIS_REST_*]
                SocialEnv[Social: DISCORD, LINKEDIN, TELEGRAM, TWITTER]
            end
            
            subgraph "Web Lambda Environment"
                WebEnv[TZ: Asia/Singapore]
                PublicEnv[NEXT_PUBLIC_API_URL, NEXT_PUBLIC_APP_ENV]
                WebRedis[UPSTASH_REDIS_REST_*]
                WebAuth[SG_CARS_TRENDS_API_TOKEN, REVALIDATE_TOKEN]
                WebDB[DATABASE_URL]
            end
        end
    end
    
    %% External Services
    subgraph "External Services"
        %% Data Sources
        subgraph "Data Sources"
            LTA[LTA DataMall APIs]
            GeminiAI[Google Gemini AI]
        end
        
        %% Message Queue
        QStash[QStash Workflow Orchestrator]
        
        %% Databases
        subgraph "Managed Databases"
            PostgreSQL[(PostgreSQL Database)]
            Upstash[(Upstash Redis Cache)]
        end
        
        %% Social Media
        subgraph "Social Media APIs"
            Discord[Discord Webhooks]
            LinkedIn[LinkedIn API]
            Telegram[Telegram Bot API]
            Twitter[Twitter API]
        end
    end
    
    %% Traffic Flow
    Users --> Cloudflare
    Developers --> Cloudflare
    
    %% DNS Resolution
    Cloudflare --> ProdDomain
    Cloudflare --> StagingDomain  
    Cloudflare --> DevDomain
    Cloudflare --> APIDomain
    Cloudflare --> APIStagingDomain
    Cloudflare --> APIDevDomain
    
    %% CloudFront Distribution
    ProdDomain --> CloudFront
    StagingDomain --> CloudFront
    DevDomain --> CloudFront
    
    %% Router Distribution
    CloudFront --> Router
    
    %% API Traffic
    APIDomain --> Router
    APIStagingDomain --> Router
    APIDevDomain --> Router
    Router --> APIGateway
    APIGateway --> APILambda
    
    %% Web Traffic
    Router --> NextjsSSR
    Router --> StaticAssets
    
    %% Function Configuration
    APILambda --> APIRuntime
    APILambda --> APITimeout
    APILambda --> HonoApp
    
    NextjsSSR --> WebRuntime
    NextjsSSR --> WebWarm
    NextjsSSR --> NextjsFramework
    
    %% Environment Configuration
    APILambda --> CoreEnv
    APILambda --> AIEnv
    APILambda --> QStashEnv
    APILambda --> RedisEnv
    APILambda --> SocialEnv
    
    NextjsSSR --> WebEnv
    NextjsSSR --> PublicEnv
    NextjsSSR --> WebRedis
    NextjsSSR --> WebAuth
    NextjsSSR --> WebDB
    
    %% External Connections
    APILambda --> LTA
    APILambda --> GeminiAI
    APILambda --> QStash
    APILambda --> PostgreSQL
    APILambda --> Upstash
    APILambda --> Discord
    APILambda --> LinkedIn
    APILambda --> Telegram
    APILambda --> Twitter
    
    NextjsSSR --> PostgreSQL
    NextjsSSR --> Upstash
    
    %% Stage Configuration Notes
    subgraph "Stage Management"
        PermanentStages[Permanent Stages: prod, staging]
        EphemeralStages[Ephemeral Stages: pr-*, dev]
        DomainStrategy[Domain Strategy: Subdomain vs Environment prefix]
        CORSConfig[Stage-specific CORS Configuration]
    end
    
    %% Styling
    classDef aws fill:#ff9900,color:#000
    classDef external fill:#e0e0e0
    classDef dns fill:#f76707
    classDef function fill:#7c4dff,color:#fff
    classDef database fill:#4caf50,color:#fff
    classDef social fill:#2196f3,color:#fff
    
    class CloudFront,Router,APIGateway,APILambda,NextjsSSR,StaticAssets aws
    class Cloudflare dns
    class APIRuntime,APITimeout,HonoApp,WebRuntime,WebWarm,NextjsFramework,CoreEnv,AIEnv,QStashEnv,RedisEnv,SocialEnv,WebEnv,PublicEnv,WebRedis,WebAuth,WebDB function
    class PostgreSQL,Upstash database
    class LTA,GeminiAI,QStash external
    class Discord,LinkedIn,Telegram,Twitter social